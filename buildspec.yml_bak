version: 0.2
 
phases:
  install:
    commands:
     - echo "Installing kubectl 1.16"
     - curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.16.13/2020-08-04/bin/linux/amd64/kubectl
     - chmod +x ./kubectl
     - mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$PATH:$HOME/bin
     - echo 'export PATH=$PATH:$HOME/bin' >> ~/.bashrc
  pre_build:
    commands:
      - echo "Logging in to ECR..."
      - docker login $REPOSITORY_URI -u AWS -p $(aws ecr get-login-password --region $AWS_DEFAULT_REGION)
      - echo "Updating kubeconfig for dev cluster"
      - aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_DEFAULT_REGION
  build:
    commands:
      - echo "Build started at `date`"
      - echo 'Building new docker image..'
      - docker build -t $REPOSITORY_URI/rpg:latest .
  post_build:
    commands:
      - echo "Build completed at `date`"
      - echo "Pushing new image to ECR."
      - docker push $REPOSITORY_URI/rpg:latest
      - echo "Initiate rolling update to deployment"
      - kubectl set image deployment/$DEPLOYMENT $CONTAINER_NAME=$REPOSITORY_URI/rpg:latest
      - kubectl rollout status deployment $DEPLOYMENT
